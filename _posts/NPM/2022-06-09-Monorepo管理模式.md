---
layout: post
filename: 2022-06-09-Monorepo管理模式
title: Monorepo管理模式
date: 2022-06-09 19:54:21 +0800
categories: monorepo
tags: monorepo
---



## 什么是 monorepo?

`monorepo`是一种将多个`package`放在一个`repo`中的代码管理模式，摒弃了传统的多个`package`多个`repo`的模式。 目前 `Babel`, `React`, `Angular`, `Ember`, `Meteor`,` Jest`等许多开源项目都使用该种模式来管理代码。



##  如何实现 monorepo？

目前业界最佳实践是采用`yarn workspace` + `lerna` 来实现，vue3.0 也是采用二者结合的方式来实现。webpack

`yarn workspace` 能够实如今一个项目中实现多个模块的依赖新增和共用，而 lerna 的功能则更完善，不只能够管理多个模块，还有清除模块 node_modules，发布模块到 npm，自动更新模块间版本依赖，并支持全量发布和根据改动单独发布等功能。git

`yarn` 官方推荐用 `yarn` 来处理依赖安装，用 `lerna` 来处理依赖更新和发布问题



### 全局安装 yarn 和 lerna

```shell
npm i -g yarn lerna
```

### 初始化项目 - lerna init

```shell
mkdir monorepoProject && cd monorepoProject
$ lerna init

// 此时项目结构
monorepoProject
|-packages
|-lerna.json
|-package.json
```

### 添加 yarn workspace 配置

```json
"private": true, // 项目根目录下的private必须设置成true，不然workspace不会被启用
"workspaces": [  // 指定须要管理的模块
    "packages/*"
]
```

### 添加模块内容

```shell
// 此时项目结构
monorepoProject
|-node_modules      // 公共node_modules
|-packages          // packages下的全部包结构相似，下面仅展现了compiler-core包的目录结构
    |-testPackagesA         // 项目a
        |-src               // 源文件
        |-package.json      // 包配置
        |-README.md         //  说明文档
    |-testPackagesB       // 项目b
    |-testPackagesC       // 项目c
|-lerna.json
|-package.json
|-tsconfig.json       // ts配置文件
```

### 安装相关依赖

给根项目安装依赖（通常是公用的开发工具）

```shell
# yarn 使用 workspace 模式安装 npm 包时必须加 -W 参数
yarn add -W -D rollup typescript babel esbuild ...
```

给`子项目`安装依赖到`根目录 node_modules`

```shell
 # testPackagesA 是取 monorepoProject/packages/testPackagesA/package.json 的 name 字段
 yarn workspace testPackagesA add axios estree-walker source-map -D
```

给`子项目`安装依赖到 `子项目目录 node_modules`

```shell
 # testPackagesA 是取 monorepoProject/packages/testPackagesA/package.json 的 name 字段
 yarn workspace testPackagesA add @axios@^1.0.0 # 首次安装必须携带正确版本号，否则否则会到npm查找包
```



## lerna

一个在 js 项目中用来管理多个 package 的工具。 主要是便于开发者更加高效简便地管理 package 自己，依赖，发布。

### 初始化

```bash
# 生成基本项目结构和 lerna 配置
 lerna init
```

### 清除 pacakge 中多余的 node_modules

有时由于我们不当设置，或者误操作会在 pacakge 中创建 node_modules

```shell
monorepoProject
|-node_modules      # 公共node_modules
|-packages
    |-testPackagesA
        |-src
        |-node_modules       # 异常node_modules
        |-package.json
        |-README.md
    |-testPackagesB
|-lerna.json
|-package.json
|-tsconfig.json


# 此时我们执行
lerna clean
```

### 查看全部 pacakge

```shell
# package.json 中设置了 "private": true 的 package 不会展现
lerna ls
```

### 查看有改动的 pacakge

```shell
# package.json 中设置了 "private": true 的 package 不会展现
lerna changed
```

### 推送到 git 和发布到 npm

```shell
lerna publish
```

