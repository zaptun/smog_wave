---
layout: post
filename: 2022-07-29-JS录音并转换成文件下载
title: JS录音并转换成文件下载
date: 2022-07-29 00:03:42 +0800
categories: audio MediaRecorder
tags: revokeObjectURL MediaRecorder createObjectURL Blob
---

要开发一个页面，功能是录音并保存文件，然后发给接口做语音识别，再返回识别结果。

先做需求拆解

第一步：

### 1. H5录音

#### 1.1. 获取录音权限

使用api: **[navigator.mediaDevices.getUserMedia][1]** 可以拿到录音的音频文件媒体流(MediaStream)

```javascript
export const getUserAuthI = () => {
  return new Promise<userAuthData>((resolve, reject) => {
    if (navigator.mediaDevices.getUserMedia) {
      const options = { audio: true };
      navigator.mediaDevices.getUserMedia(options).then(
        (stream: MediaStream) => {
          resolve({ statue: true, stream });
        },
        () => {
          reject({ status: false, stream: null });
          console.error("授权失败");
        }
      );
    } else {
      reject({ status: false, stream: null });
      console.error("浏览器不支持,无法获取麦克风");
    }
  });
};
```
#### 1.2. 生成文件

用 **[MediaRecorder][2]** 把拿到的 MediaStream 转成Bolb 再转成文件

**转成Bolb**

生成blob，再转成file 或 Objurl, 如果使用了[createObjectURL][4]，注意要用 [revokeObjectURL][3] 销毁，否则会一直占用内存。

```javascript
let chunks = [];
// stream为获取权限时,取到的stream
const mediaRecorder = new MediaRecorder(stream);

function bindEvents(target) {
    target.addEventListener("dataavailable", (e) => {
      chunks.push(e.data);
    });

    target.addEventListener("stop", (e: Event) => {
      const blobType = { type: "audio/wav; codecs=wav" };

      const blob = new Blob(chunks, blobType));

      // 转换成ObjURL
      audioObjURL = window.URL.createObjectURL(blob);

      /* 结束清空chunks */
      chunks = [];

      // 转换成文件
      const fileName = Date.now().toString(32);
      const fileType = "audio/wav";
      const file = new window.File([blob], fileName, { type: fileType });
  
      // 下载
      const a = document.createElement("a");
      a.href = audioObjURL;
      a.download = fileName;
      a.click();
    });
}

bindEvents(mediaRecorder);
```

#### 1.3. input file 转 Blob

input发送本地file到webscoket端口，测试识别

`const files = Array.form(target.files); new Blob(files);`

```javascript
InputDom.onchange = (e: Event) => {
  const target = e.target;
  if (target && window.globalWs) {
    const blob = new Blob(target["files"], { type: "audio/wav" });
    window.globalWs.send(blob);
  }
};
```

#### 1.4. 页面销毁前关闭ws连接

[beforeunload][5] 页面销毁前关闭ws连接，并revokeObjectURL

```javascript
window.addEventListener("beforeunload", event => {
  recorder.audioObjURL && window.URL.revokeObjectURL(recorder.audioObjURL);
  window.globalWs && window.globalWs.close();

  event.preventDefault();
  event.returnValue = "";
});
```

>chrome60以后，如果用户打开浏览器后没有任何交互，直接关闭网页，则不会触发beforeunload事件 https://www.chromestatus.com/feature/5082396709879808



----

### 2. 项目用的最终文件参考

record.ts

```javascript
interface RecordAudioCallback {
  start?: (e: Event, t: RecordAudio) => void;
  stop?: (e: Event, t: RecordAudio) => void;
  pause?: (e: Event, t: RecordAudio) => void;
}

interface userAuthData {
  statue: boolean;
  stream: MediaStream;
}

export class RecordAudio {
  public mediaRecorder: MediaRecorder;
  private chunks: BlobPart[];
  public audioBlob: Blob | undefined;
  public audioObjURL: string | undefined;
  private callback: RecordAudioCallback | null;

  constructor(stream: MediaStream, callback?: Record<string, unknown>) {
    // stream为获取权限时,取到的stream
    this.mediaRecorder = new MediaRecorder(stream);
    this.chunks = [];
    this.audioBlob = undefined;
    this.audioObjURL = undefined;
    this.callback = callback || null;

    this.bindEvents(this.mediaRecorder);
  }

  private bindEvents(target: MediaRecorder) {
    target.addEventListener("dataavailable", (e: Event) => {
      this.chunks.push(e["data"]);
    });

    target.addEventListener("stop", (e: Event) => {
      /* 不同的格式 */
      // const blobType = { type: "audio/ogg; codecs=opus" };
      const blobType = { type: "audio/wav; codecs=wav" };

      const blob = (this.audioBlob = new Blob(this.chunks, blobType));

      // 转换成url
      this.audioObjURL = window.URL.createObjectURL(blob);

      /* 结束清空chunks */
      this.chunks = [];

      /* 处理回调 */
      if (this.callback && this.callback.stop && typeof this.callback.stop == "function") {
        this.callback.stop(e, this);
      }
    });
  }

  /* 下载文件 */
  public downloadFile() {
    if (!(this.audioBlob && this.audioObjURL)) return;
    // 转换成文件
    const fileName = Date.now().toString(32);
    // const fileType = "audio/ogg";
    const fileType = "audio/wav";
    const file = new window.File([this.audioBlob], fileName, { type: fileType });

    // 下载
    const a = document.createElement("a");
    a.href = this.audioObjURL;
    a.download = fileName;
    a.click();
  }

  /* 销毁记录 */
  public clean() {
    this.audioBlob = undefined;
    this.audioObjURL && window.URL.revokeObjectURL(this.audioObjURL);
  }
}

export const getUserAuthI = () => {
  return new Promise<userAuthData>((resolve, reject) => {
    if (navigator.mediaDevices.getUserMedia) {
      const options = { audio: true };
      navigator.mediaDevices.getUserMedia(options).then(
        (stream: MediaStream) => {
          resolve({ statue: true, stream });
        },
        () => {
          reject({ status: false, stream: null });
          console.error("授权失败");
        }
      );
    } else {
      reject({ status: false, stream: null });
      console.error("浏览器不支持,无法获取麦克风");
    }
  });
};
```

### API参考文档

[getUserMedia API DOC](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)

[MediaRecorder API DOC](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaRecorder/MediaRecorder)

[revokeObjectURL API DOC](https://developer.mozilla.org/zh-CN/docs/Web/API/URL/revokeObjectURL)

[createObjectURL API DOC](https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL)

[beforeunload_event API DOC](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/beforeunload_event)

[1]: https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia
[2]: https://developer.mozilla.org/zh-CN/docs/Web/API/MediaRecorder/MediaRecorder
[3]: https://developer.mozilla.org/zh-CN/docs/Web/API/URL/revokeObjectURL
[4]: https://developer.mozilla.org/zh-CN/docs/Web/API/URL/createObjectURL
[5]: https://developer.mozilla.org/zh-CN/docs/Web/API/Window/beforeunload_event
