---
layout: post
filename: 2022-07-11-Vite常用配置
title: Vite常用配置
date: 2022-07-11 22:42:46 +0800
categories: vite
tags: vite
---



# Vite常用配置

## css合并

```js
build: {
	 // 禁用css切割，只输出一个css
  cssCodeSplit: false,
  rollupOptions: {
    input: {
      index: resolve(__dirname, "index.html")
      // project:resolve(__dirname,"project.html")
    },
    output: {
      chunkFileNames: 'assets/js/[name]-[hash].js',
      entryFileNames: "assets/js/[name]-[hash].js",
      assetFileNames: (assetName) => {
        if (/\.css/.test((assetName.name as string))) {
          return "assets/css/[name]-[hash].css"
        } else {
          return "assets/media/[name]-[hash].[ext]"
        }
      }
    }
  }
}
```

## JS合并

```js
build: {
  rollupOptions: {
    output: {
      manualChunks: isClient ? () => "app" : undefined
      //...
    }
  }
},
```





## @charset 报错

@charset" must be the first rule in the file

> vite2在build的时候发生警告 warning: "@charset" must be the first rule in the file #5626

vite.config.ts中添加了

css: { preprocessorOptions: { scss: { charset: false, } } },

```js
css: {
  preprocessorOptions: {
    scss: {
      additionalData: `@import "@css/variables";`,
      charset: false,
    },
  },
  postcss: {
    plugins: [
      {
        postcssPlugin: 'internal:charset-removal',
        AtRule: {
          charset: (atRule) => {
            if (atRule.name === 'charset') {
              atRule.remove();
            }
          }
        }
      }
    ]
  }
},
```



## 样板配置

```js
import { defineConfig } from "vite";
import { resolve } from "path";
import inject from "rollup-plugin-inject";
import banner from "vite-plugin-banner";
import htmlMinifierTerser from "vite-plugin-html-minifier-terser";

const pkgname = process.env.npm_package_name;
const pkgversion = process.env.npm_package_version;
const bannertime = (new Date()).toLocaleString();

export default defineConfig(({ mode }) => {
    const isProduction = mode === "production";
    return {
        resolve: {
            extensions: [".mjs", ".js", ".ts", ".jsx", ".tsx", ".json"],
            alias: {
                "@": resolve("./src"),
                "@assets": resolve("./src/assets"),
                "@script": resolve("./src/assets/script"),
                "@css": resolve("./src/assets/css"),
                "@img": resolve("./src/assets/img"),
                "@video": resolve("./src/assets/video")
            }
        },
        css: {
            preprocessorOptions: {
                scss: {
                    additionalData: `@import "@css/variables";`
                }
            }
        },
        assetsInclude: ["**/*.json"],
        base: isProduction ? "/home/" : "./",
        build: {
            target: "es2015",
            assetsDir: "assets",
            minify: "terser",
            //生产环境关闭map
            sourcemap: !isProduction,
            terserOptions: {
                //生产环境移除 console debugger
                compress: {
                    drop_console: isProduction,
                    drop_debugger: isProduction,
                    pure_funcs: ["console.log", "console.error"], 
                    //配置移除指定的指令，如console.log,alert等
                },
                //生产环境清空注释
                format: {
                    comments: !isProduction,
                },
            },
            //禁用css切割，只输出一个css
            cssCodeSplit: false,
            //分类不同文件目录
            rollupOptions: {
                input: {
                    index: resolve(__dirname, "index.html"),
                    // project:resolve(__dirname,"project.html")
                },
                output: {
                    chunkFileNames: 'assets/js/[name]-[hash].js',
                    entryFileNames: "assets/js/[name]-[hash].js",
                    assetFileNames: (assetName) => {
                        if (/\.css/.test(assetName.name)) {
                            return "assets/css/[name]-[hash].css"
                        } else {
                            return "assets/media/[name]-[hash].[ext]"
                        }
                    }
                },
                plugins: [
                    inject({
                        // control which files this plugin applies to
                        // with include/exclude
                        include: "**/*.js",
                        exclude: "node_modules/**",
                        $: "jquery",
                        modules: {
                            $: "jquery"
                        }
                    }),
                ]
            },
        },
        // esbuild: {
        //   logLevel: "warning", // 配置控制台输出级别，减少 打印
        //   drop: isProduction ? ["console"] : [] // 压缩去掉console.log
        // },
        //指定依赖不预编译
        // optimizeDeps: {
        //   exclude: ["@datastar/warlock-jssdk"]
        // },
        server: {
            port: 8096,
            open: true,
            cors: true,
        },
        plugins: [
            inject({
                // control which files this plugin applies to
                // with include/exclude
                include: "**/*.js",
                exclude: "node_modules/**",
                $: "jquery",
                modules: {
                    $: "jquery"
                }
            }),
            //压缩html
            htmlMinifierTerser({
                removeAttributeQuotes: true,
                collapseWhitespace: true,
            }),
            //增加版权注释
            banner(`/**\n * name: ${pkgname}\n * version: v${pkgversion}\n * copyright: spidernote.com\n * date: ${bannertime}\n */`),
        ]
    };
});
```

